AdaptiveSparkPlan isFinalPlan=true
+- == Final Plan ==
   NativeTakeOrdered 100, [(sum_sales#1 - avg_monthly_sales#2) ASC NULLS FIRST, s_store_name#3 ASC NULLS FIRST]
   +- NativeProject [i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7, d_moy#8, avg_monthly_sales#2, sum_sales#1, sum_sales#9 AS psum#10, sum_sales#11 AS nsum#12]
      +- NativeSortMergeJoin [i_category#4, i_brand#5, s_store_name#3, s_company_name#6, rn#13], [i_category#14, i_brand#15, s_store_name#16, s_company_name#17, (rn#18 - 1)], Inner
         :- NativeProject [i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7, d_moy#8, sum_sales#1, avg_monthly_sales#2, rn#13, sum_sales#9]
         :  +- NativeSortMergeJoin [i_category#4, i_brand#5, s_store_name#3, s_company_name#6, rn#13], [i_category#19, i_brand#20, s_store_name#21, s_company_name#22, (rn#23 + 1)], Inner
         :     :- NativeSort [i_category#4 ASC NULLS FIRST, i_brand#5 ASC NULLS FIRST, s_store_name#3 ASC NULLS FIRST, s_company_name#6 ASC NULLS FIRST, rn#13 ASC NULLS FIRST], false
         :     :  +- InputAdapter
         :     :     +- AQEShuffleRead coalesced
         :     :        +- ShuffleQueryStage 41
         :     :           +- NativeShuffleExchange hashpartitioning(i_category#4, i_brand#5, s_store_name#3, s_company_name#6, rn#13, 100), ENSURE_REQUIREMENTS, [plan_id=1]
         :     :              +- ConvertToNative
         :     :                 +- *(1) Project [i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7, d_moy#8, sum_sales#1, avg_monthly_sales#2, rn#13]
         :     :                    +- *(1) Filter ((isnotnull(avg_monthly_sales#2) AND (avg_monthly_sales#2 > 0.000000)) AND CASE WHEN (avg_monthly_sales#2 > 0.000000) THEN ((abs((sum_sales#1 - avg_monthly_sales#2)) / avg_monthly_sales#2) > 0.1000000000000000) END)
         :     :                       +- Window [avg(_w0#24) windowspecdefinition(i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS avg_monthly_sales#2], [i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7]
         :     :                          +- NativeFilter (isnotnull(d_year#7) AND (d_year#7 = 1999))
         :     :                             +- NativeWindow [rank(d_year#7, d_moy#8) windowspecdefinition(i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7 ASC NULLS FIRST, d_moy#8 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#13], [i_category#4, i_brand#5, s_store_name#3, s_company_name#6], [d_year#7 ASC NULLS FIRST, d_moy#8 ASC NULLS FIRST]
         :     :                                +- NativeSort [i_category#4 ASC NULLS FIRST, i_brand#5 ASC NULLS FIRST, s_store_name#3 ASC NULLS FIRST, s_company_name#6 ASC NULLS FIRST, d_year#7 ASC NULLS FIRST, d_moy#8 ASC NULLS FIRST], false
         :     :                                   +- InputAdapter
         :     :                                      +- AQEShuffleRead coalesced
         :     :                                         +- ShuffleQueryStage 35
         :     :                                            +- NativeShuffleExchange hashpartitioning(i_category#4, i_brand#5, s_store_name#3, s_company_name#6, 100), ENSURE_REQUIREMENTS, [plan_id=2]
         :     :                                               +- NativeProject [i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7, d_moy#8, MakeDecimal(sum(UnscaledValue(ss_sales_price#25))#26,17,2) AS sum_sales#1, MakeDecimal(sum(UnscaledValue(ss_sales_price#25))#26,17,2) AS _w0#24]
         :     :                                                  +- NativeHashAggregate HashAgg, ArrayBuffer(i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7, d_moy#8), [i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7, d_moy#8], [sum(UnscaledValue(ss_sales_price#25))], [sum(UnscaledValue(ss_sales_price#25))#26], 6
         :     :                                                     +- InputAdapter
         :     :                                                        +- AQEShuffleRead coalesced
         :     :                                                           +- ShuffleQueryStage 30
         :     :                                                              +- NativeShuffleExchange hashpartitioning(i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7, d_moy#8, 100), ENSURE_REQUIREMENTS, [plan_id=3]
         :     :                                                                 +- NativeHashAggregate HashAgg, [i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7, d_moy#8], [partial_sum(_c6#27)], [sum#28], 0
         :     :                                                                    +- NativeProject [i_category#4 AS i_category#4, i_brand#5 AS i_brand#5, s_store_name#3 AS s_store_name#3, s_company_name#6 AS s_company_name#6, d_year#7 AS d_year#7, d_moy#8 AS d_moy#8, UnscaledValue(ss_sales_price#25) AS _c6#27]
         :     :                                                                       +- NativeProject [i_brand#5, i_category#4, ss_sales_price#25, d_year#7, d_moy#8, s_store_name#3, s_company_name#6]
         :     :                                                                          +- NativeSortMergeJoin [ss_store_sk#29], [s_store_sk#30], Inner
         :     :                                                                             :- NativeSort [ss_store_sk#29 ASC NULLS FIRST], false
         :     :                                                                             :  +- InputAdapter
         :     :                                                                             :     +- AQEShuffleRead coalesced
         :     :                                                                             :        +- ShuffleQueryStage 25
         :     :                                                                             :           +- NativeShuffleExchange hashpartitioning(ss_store_sk#29, 100), ENSURE_REQUIREMENTS, [plan_id=4]
         :     :                                                                             :              +- NativeProject [i_brand#5, i_category#4, ss_store_sk#29, ss_sales_price#25, d_year#7, d_moy#8]
         :     :                                                                             :                 +- NativeSortMergeJoin [ss_sold_date_sk#31], [d_date_sk#32], Inner
         :     :                                                                             :                    :- NativeSort [ss_sold_date_sk#31 ASC NULLS FIRST], false
         :     :                                                                             :                    :  +- InputAdapter
         :     :                                                                             :                    :     +- AQEShuffleRead coalesced
         :     :                                                                             :                    :        +- ShuffleQueryStage 20
         :     :                                                                             :                    :           +- NativeShuffleExchange hashpartitioning(ss_sold_date_sk#31, 100), ENSURE_REQUIREMENTS, [plan_id=5]
         :     :                                                                             :                    :              +- NativeProject [i_brand#5, i_category#4, ss_sold_date_sk#31, ss_store_sk#29, ss_sales_price#25]
         :     :                                                                             :                    :                 +- NativeSortMergeJoin [i_item_sk#33], [ss_item_sk#34], Inner
         :     :                                                                             :                    :                    :- NativeSort [i_item_sk#33 ASC NULLS FIRST], false
         :     :                                                                             :                    :                    :  +- InputAdapter
         :     :                                                                             :                    :                    :     +- AQEShuffleRead coalesced
         :     :                                                                             :                    :                    :        +- ShuffleQueryStage 0
         :     :                                                                             :                    :                    :           +- NativeShuffleExchange hashpartitioning(i_item_sk#33, 100), ENSURE_REQUIREMENTS, [plan_id=6]
         :     :                                                                             :                    :                    :              +- NativeFilter ((isnotnull(i_item_sk#33) AND isnotnull(i_category#4)) AND isnotnull(i_brand#5))
         :     :                                                                             :                    :                    :                 +- InputAdapter [#33, #5, #4]
         :     :                                                                             :                    :                    :                    +- NativeParquetScan  (FileScan parquet [i_item_sk#33,i_brand#5,i_category#4] Batched: true, DataFilters: [isnotnull(i_item_sk#33), isnotnull(i_category#4), isnotnull(i_brand#5)], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/<warehouse_dir>], PartitionFilters: [], PushedFilters: [IsNotNull(i_item_sk), IsNotNull(i_category), IsNotNull(i_brand)], ReadSchema: struct<i_item_sk:int,i_brand:string,i_category:string>)
         :     :                                                                             :                    :                    +- NativeSort [ss_item_sk#34 ASC NULLS FIRST], false
         :     :                                                                             :                    :                       +- InputAdapter
         :     :                                                                             :                    :                          +- AQEShuffleRead coalesced
         :     :                                                                             :                    :                             +- ShuffleQueryStage 1
         :     :                                                                             :                    :                                +- NativeShuffleExchange hashpartitioning(ss_item_sk#34, 100), ENSURE_REQUIREMENTS, [plan_id=7]
         :     :                                                                             :                    :                                   +- NativeFilter ((isnotnull(ss_item_sk#34) AND isnotnull(ss_sold_date_sk#31)) AND isnotnull(ss_store_sk#29))
         :     :                                                                             :                    :                                      +- InputAdapter [#31, #34, #29, #25]
         :     :                                                                             :                    :                                         +- NativeParquetScan  (FileScan parquet [ss_sold_date_sk#31,ss_item_sk#34,ss_store_sk#29,ss_sales_price#25] Batched: true, DataFilters: [isnotnull(ss_item_sk#34), isnotnull(ss_sold_date_sk#31), isnotnull(ss_store_sk#29)], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/<warehouse_dir>], PartitionFilters: [], PushedFilters: [IsNotNull(ss_item_sk), IsNotNull(ss_sold_date_sk), IsNotNull(ss_store_sk)], ReadSchema: struct<ss_sold_date_sk:int,ss_item_sk:int,ss_store_sk:int,ss_sales_price:decimal(7,2)>)
         :     :                                                                             :                    +- NativeSort [d_date_sk#32 ASC NULLS FIRST], false
         :     :                                                                             :                       +- InputAdapter
         :     :                                                                             :                          +- AQEShuffleRead coalesced
         :     :                                                                             :                             +- ShuffleQueryStage 2
         :     :                                                                             :                                +- NativeShuffleExchange hashpartitioning(d_date_sk#32, 100), ENSURE_REQUIREMENTS, [plan_id=8]
         :     :                                                                             :                                   +- NativeFilter ((((d_year#7 = 1999) OR ((d_year#7 = 1998) AND (d_moy#8 = 12))) OR ((d_year#7 = 2000) AND (d_moy#8 = 1))) AND isnotnull(d_date_sk#32))
         :     :                                                                             :                                      +- InputAdapter [#32, #7, #8]
         :     :                                                                             :                                         +- NativeParquetScan  (FileScan parquet [d_date_sk#32,d_year#7,d_moy#8] Batched: true, DataFilters: [(((d_year#7 = 1999) OR ((d_year#7 = 1998) AND (d_moy#8 = 12))) OR ((d_year#7 = 2..., Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/<warehouse_dir>], PartitionFilters: [], PushedFilters: [Or(Or(EqualTo(d_year,1999),And(EqualTo(d_year,1998),EqualTo(d_moy,12))),And(EqualTo(d_year,2000)..., ReadSchema: struct<d_date_sk:int,d_year:int,d_moy:int>)
         :     :                                                                             +- NativeSort [s_store_sk#30 ASC NULLS FIRST], false
         :     :                                                                                +- InputAdapter
         :     :                                                                                   +- AQEShuffleRead coalesced
         :     :                                                                                      +- ShuffleQueryStage 3
         :     :                                                                                         +- NativeShuffleExchange hashpartitioning(s_store_sk#30, 100), ENSURE_REQUIREMENTS, [plan_id=9]
         :     :                                                                                            +- NativeFilter ((isnotnull(s_store_sk#30) AND isnotnull(s_store_name#3)) AND isnotnull(s_company_name#6))
         :     :                                                                                               +- InputAdapter [#30, #3, #6]
         :     :                                                                                                  +- NativeParquetScan  (FileScan parquet [s_store_sk#30,s_store_name#3,s_company_name#6] Batched: true, DataFilters: [isnotnull(s_store_sk#30), isnotnull(s_store_name#3), isnotnull(s_company_name#6)], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/<warehouse_dir>], PartitionFilters: [], PushedFilters: [IsNotNull(s_store_sk), IsNotNull(s_store_name), IsNotNull(s_company_name)], ReadSchema: struct<s_store_sk:int,s_store_name:string,s_company_name:string>)
         :     +- NativeSort [i_category#19 ASC NULLS FIRST, i_brand#20 ASC NULLS FIRST, s_store_name#21 ASC NULLS FIRST, s_company_name#22 ASC NULLS FIRST, (rn#23 + 1) ASC NULLS FIRST], false
         :        +- InputAdapter
         :           +- AQEShuffleRead coalesced
         :              +- ShuffleQueryStage 39
         :                 +- NativeShuffleExchange hashpartitioning(i_category#19, i_brand#20, s_store_name#21, s_company_name#22, (rn#23 + 1), 100), ENSURE_REQUIREMENTS, [plan_id=10]
         :                    +- NativeProject [i_category#19, i_brand#20, s_store_name#21, s_company_name#22, sum_sales#1 AS sum_sales#9, rn#23]
         :                       +- NativeWindow [rank(d_year#35, d_moy#36) windowspecdefinition(i_category#19, i_brand#20, s_store_name#21, s_company_name#22, d_year#35 ASC NULLS FIRST, d_moy#36 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#23], [i_category#19, i_brand#20, s_store_name#21, s_company_name#22], [d_year#35 ASC NULLS FIRST, d_moy#36 ASC NULLS FIRST]
         :                          +- NativeSort [i_category#19 ASC NULLS FIRST, i_brand#20 ASC NULLS FIRST, s_store_name#21 ASC NULLS FIRST, s_company_name#22 ASC NULLS FIRST, d_year#35 ASC NULLS FIRST, d_moy#36 ASC NULLS FIRST], false
         :                             +- InputAdapter
         :                                +- AQEShuffleRead coalesced
         :                                   +- ShuffleQueryStage 36
         :                                      +- NativeShuffleExchange hashpartitioning(i_category#19, i_brand#20, s_store_name#21, s_company_name#22, 100), ENSURE_REQUIREMENTS, [plan_id=11]
         :                                         +- NativeProject [i_category#19, i_brand#20, s_store_name#21, s_company_name#22, d_year#35, d_moy#36, MakeDecimal(sum(UnscaledValue(ss_sales_price#37))#26,17,2) AS sum_sales#1]
         :                                            +- NativeHashAggregate HashAgg, ArrayBuffer(i_category#19, i_brand#20, s_store_name#21, s_company_name#22, d_year#35, d_moy#36), [i_category#19, i_brand#20, s_store_name#21, s_company_name#22, d_year#35, d_moy#36], [sum(UnscaledValue(ss_sales_price#37))], [sum(UnscaledValue(ss_sales_price#37))#26], 6
         :                                               +- InputAdapter
         :                                                  +- InputAdapter [#19, #20, #21, #22, #35, #36, #38]
         :                                                     +- AQEShuffleRead coalesced
         :                                                        +- ShuffleQueryStage 32
         :                                                           +- ReusedExchange [i_category#19, i_brand#20, s_store_name#21, s_company_name#22, d_year#35, d_moy#36, sum#39], NativeShuffleExchange hashpartitioning(i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7, d_moy#8, 100), ENSURE_REQUIREMENTS, [plan_id=3]
         +- NativeSort [i_category#14 ASC NULLS FIRST, i_brand#15 ASC NULLS FIRST, s_store_name#16 ASC NULLS FIRST, s_company_name#17 ASC NULLS FIRST, (rn#18 - 1) ASC NULLS FIRST], false
            +- InputAdapter
               +- AQEShuffleRead coalesced
                  +- ShuffleQueryStage 40
                     +- NativeShuffleExchange hashpartitioning(i_category#14, i_brand#15, s_store_name#16, s_company_name#17, (rn#18 - 1), 100), ENSURE_REQUIREMENTS, [plan_id=12]
                        +- NativeProject [i_category#14, i_brand#15, s_store_name#16, s_company_name#17, sum_sales#1 AS sum_sales#11, rn#18]
                           +- NativeWindow [rank(d_year#40, d_moy#41) windowspecdefinition(i_category#14, i_brand#15, s_store_name#16, s_company_name#17, d_year#40 ASC NULLS FIRST, d_moy#41 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#18], [i_category#14, i_brand#15, s_store_name#16, s_company_name#17], [d_year#40 ASC NULLS FIRST, d_moy#41 ASC NULLS FIRST]
                              +- NativeSort [i_category#14 ASC NULLS FIRST, i_brand#15 ASC NULLS FIRST, s_store_name#16 ASC NULLS FIRST, s_company_name#17 ASC NULLS FIRST, d_year#40 ASC NULLS FIRST, d_moy#41 ASC NULLS FIRST], false
                                 +- InputAdapter
                                    +- InputAdapter [#14, #15, #16, #17, #40, #41, #1]
                                       +- AQEShuffleRead coalesced
                                          +- ShuffleQueryStage 38
                                             +- ReusedExchange [i_category#14, i_brand#15, s_store_name#16, s_company_name#17, d_year#40, d_moy#41, sum_sales#1], NativeShuffleExchange hashpartitioning(i_category#19, i_brand#20, s_store_name#21, s_company_name#22, 100), ENSURE_REQUIREMENTS, [plan_id=11]
+- == Initial Plan ==
   TakeOrderedAndProject(limit=100, orderBy=[(sum_sales#1 - avg_monthly_sales#2) ASC NULLS FIRST,s_store_name#3 ASC NULLS FIRST], output=[i_category#4,i_brand#5,s_store_name#3,s_company_name#6,d_year#7,d_moy#8,avg_monthly_sales#2,sum_sales#1,psum#10,nsum#12])
   +- Project [i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7, d_moy#8, avg_monthly_sales#2, sum_sales#1, sum_sales#9 AS psum#10, sum_sales#11 AS nsum#12]
      +- SortMergeJoin [i_category#4, i_brand#5, s_store_name#3, s_company_name#6, rn#13], [i_category#14, i_brand#15, s_store_name#16, s_company_name#17, (rn#18 - 1)], Inner
         :- Project [i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7, d_moy#8, sum_sales#1, avg_monthly_sales#2, rn#13, sum_sales#9]
         :  +- SortMergeJoin [i_category#4, i_brand#5, s_store_name#3, s_company_name#6, rn#13], [i_category#19, i_brand#20, s_store_name#21, s_company_name#22, (rn#23 + 1)], Inner
         :     :- Sort [i_category#4 ASC NULLS FIRST, i_brand#5 ASC NULLS FIRST, s_store_name#3 ASC NULLS FIRST, s_company_name#6 ASC NULLS FIRST, rn#13 ASC NULLS FIRST], false, 0
         :     :  +- Exchange hashpartitioning(i_category#4, i_brand#5, s_store_name#3, s_company_name#6, rn#13, 100), ENSURE_REQUIREMENTS, [plan_id=13]
         :     :     +- Project [i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7, d_moy#8, sum_sales#1, avg_monthly_sales#2, rn#13]
         :     :        +- Filter ((isnotnull(avg_monthly_sales#2) AND (avg_monthly_sales#2 > 0.000000)) AND CASE WHEN (avg_monthly_sales#2 > 0.000000) THEN ((abs((sum_sales#1 - avg_monthly_sales#2)) / avg_monthly_sales#2) > 0.1000000000000000) END)
         :     :           +- Window [avg(_w0#24) windowspecdefinition(i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS avg_monthly_sales#2], [i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7]
         :     :              +- Filter (isnotnull(d_year#7) AND (d_year#7 = 1999))
         :     :                 +- Window [rank(d_year#7, d_moy#8) windowspecdefinition(i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7 ASC NULLS FIRST, d_moy#8 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#13], [i_category#4, i_brand#5, s_store_name#3, s_company_name#6], [d_year#7 ASC NULLS FIRST, d_moy#8 ASC NULLS FIRST]
         :     :                    +- Sort [i_category#4 ASC NULLS FIRST, i_brand#5 ASC NULLS FIRST, s_store_name#3 ASC NULLS FIRST, s_company_name#6 ASC NULLS FIRST, d_year#7 ASC NULLS FIRST, d_moy#8 ASC NULLS FIRST], false, 0
         :     :                       +- Exchange hashpartitioning(i_category#4, i_brand#5, s_store_name#3, s_company_name#6, 100), ENSURE_REQUIREMENTS, [plan_id=14]
         :     :                          +- HashAggregate(keys=[i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7, d_moy#8], functions=[sum(UnscaledValue(ss_sales_price#25))], output=[i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7, d_moy#8, sum_sales#1, _w0#24])
         :     :                             +- Exchange hashpartitioning(i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7, d_moy#8, 100), ENSURE_REQUIREMENTS, [plan_id=15]
         :     :                                +- HashAggregate(keys=[i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7, d_moy#8], functions=[partial_sum(UnscaledValue(ss_sales_price#25))], output=[i_category#4, i_brand#5, s_store_name#3, s_company_name#6, d_year#7, d_moy#8, sum#42])
         :     :                                   +- Project [i_brand#5, i_category#4, ss_sales_price#25, d_year#7, d_moy#8, s_store_name#3, s_company_name#6]
         :     :                                      +- SortMergeJoin [ss_store_sk#29], [s_store_sk#30], Inner
         :     :                                         :- Sort [ss_store_sk#29 ASC NULLS FIRST], false, 0
         :     :                                         :  +- Exchange hashpartitioning(ss_store_sk#29, 100), ENSURE_REQUIREMENTS, [plan_id=16]
         :     :                                         :     +- Project [i_brand#5, i_category#4, ss_store_sk#29, ss_sales_price#25, d_year#7, d_moy#8]
         :     :                                         :        +- SortMergeJoin [ss_sold_date_sk#31], [d_date_sk#32], Inner
         :     :                                         :           :- Sort [ss_sold_date_sk#31 ASC NULLS FIRST], false, 0
         :     :                                         :           :  +- Exchange hashpartitioning(ss_sold_date_sk#31, 100), ENSURE_REQUIREMENTS, [plan_id=17]
         :     :                                         :           :     +- Project [i_brand#5, i_category#4, ss_sold_date_sk#31, ss_store_sk#29, ss_sales_price#25]
         :     :                                         :           :        +- SortMergeJoin [i_item_sk#33], [ss_item_sk#34], Inner
         :     :                                         :           :           :- Sort [i_item_sk#33 ASC NULLS FIRST], false, 0
         :     :                                         :           :           :  +- Exchange hashpartitioning(i_item_sk#33, 100), ENSURE_REQUIREMENTS, [plan_id=18]
         :     :                                         :           :           :     +- Filter ((isnotnull(i_item_sk#33) AND isnotnull(i_category#4)) AND isnotnull(i_brand#5))
         :     :                                         :           :           :        +- FileScan parquet [i_item_sk#33,i_brand#5,i_category#4] Batched: true, DataFilters: [isnotnull(i_item_sk#33), isnotnull(i_category#4), isnotnull(i_brand#5)], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/<warehouse_dir>], PartitionFilters: [], PushedFilters: [IsNotNull(i_item_sk), IsNotNull(i_category), IsNotNull(i_brand)], ReadSchema: struct<i_item_sk:int,i_brand:string,i_category:string>
         :     :                                         :           :           +- Sort [ss_item_sk#34 ASC NULLS FIRST], false, 0
         :     :                                         :           :              +- Exchange hashpartitioning(ss_item_sk#34, 100), ENSURE_REQUIREMENTS, [plan_id=19]
         :     :                                         :           :                 +- Filter ((isnotnull(ss_item_sk#34) AND isnotnull(ss_sold_date_sk#31)) AND isnotnull(ss_store_sk#29))
         :     :                                         :           :                    +- FileScan parquet [ss_sold_date_sk#31,ss_item_sk#34,ss_store_sk#29,ss_sales_price#25] Batched: true, DataFilters: [isnotnull(ss_item_sk#34), isnotnull(ss_sold_date_sk#31), isnotnull(ss_store_sk#29)], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/<warehouse_dir>], PartitionFilters: [], PushedFilters: [IsNotNull(ss_item_sk), IsNotNull(ss_sold_date_sk), IsNotNull(ss_store_sk)], ReadSchema: struct<ss_sold_date_sk:int,ss_item_sk:int,ss_store_sk:int,ss_sales_price:decimal(7,2)>
         :     :                                         :           +- Sort [d_date_sk#32 ASC NULLS FIRST], false, 0
         :     :                                         :              +- Exchange hashpartitioning(d_date_sk#32, 100), ENSURE_REQUIREMENTS, [plan_id=20]
         :     :                                         :                 +- Filter ((((d_year#7 = 1999) OR ((d_year#7 = 1998) AND (d_moy#8 = 12))) OR ((d_year#7 = 2000) AND (d_moy#8 = 1))) AND isnotnull(d_date_sk#32))
         :     :                                         :                    +- FileScan parquet [d_date_sk#32,d_year#7,d_moy#8] Batched: true, DataFilters: [(((d_year#7 = 1999) OR ((d_year#7 = 1998) AND (d_moy#8 = 12))) OR ((d_year#7 = 2..., Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/<warehouse_dir>], PartitionFilters: [], PushedFilters: [Or(Or(EqualTo(d_year,1999),And(EqualTo(d_year,1998),EqualTo(d_moy,12))),And(EqualTo(d_year,2000)..., ReadSchema: struct<d_date_sk:int,d_year:int,d_moy:int>
         :     :                                         +- Sort [s_store_sk#30 ASC NULLS FIRST], false, 0
         :     :                                            +- Exchange hashpartitioning(s_store_sk#30, 100), ENSURE_REQUIREMENTS, [plan_id=21]
         :     :                                               +- Filter ((isnotnull(s_store_sk#30) AND isnotnull(s_store_name#3)) AND isnotnull(s_company_name#6))
         :     :                                                  +- FileScan parquet [s_store_sk#30,s_store_name#3,s_company_name#6] Batched: true, DataFilters: [isnotnull(s_store_sk#30), isnotnull(s_store_name#3), isnotnull(s_company_name#6)], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/<warehouse_dir>], PartitionFilters: [], PushedFilters: [IsNotNull(s_store_sk), IsNotNull(s_store_name), IsNotNull(s_company_name)], ReadSchema: struct<s_store_sk:int,s_store_name:string,s_company_name:string>
         :     +- Sort [i_category#19 ASC NULLS FIRST, i_brand#20 ASC NULLS FIRST, s_store_name#21 ASC NULLS FIRST, s_company_name#22 ASC NULLS FIRST, (rn#23 + 1) ASC NULLS FIRST], false, 0
         :        +- Exchange hashpartitioning(i_category#19, i_brand#20, s_store_name#21, s_company_name#22, (rn#23 + 1), 100), ENSURE_REQUIREMENTS, [plan_id=22]
         :           +- Project [i_category#19, i_brand#20, s_store_name#21, s_company_name#22, sum_sales#1 AS sum_sales#9, rn#23]
         :              +- Window [rank(d_year#35, d_moy#36) windowspecdefinition(i_category#19, i_brand#20, s_store_name#21, s_company_name#22, d_year#35 ASC NULLS FIRST, d_moy#36 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#23], [i_category#19, i_brand#20, s_store_name#21, s_company_name#22], [d_year#35 ASC NULLS FIRST, d_moy#36 ASC NULLS FIRST]
         :                 +- Sort [i_category#19 ASC NULLS FIRST, i_brand#20 ASC NULLS FIRST, s_store_name#21 ASC NULLS FIRST, s_company_name#22 ASC NULLS FIRST, d_year#35 ASC NULLS FIRST, d_moy#36 ASC NULLS FIRST], false, 0
         :                    +- Exchange hashpartitioning(i_category#19, i_brand#20, s_store_name#21, s_company_name#22, 100), ENSURE_REQUIREMENTS, [plan_id=23]
         :                       +- HashAggregate(keys=[i_category#19, i_brand#20, s_store_name#21, s_company_name#22, d_year#35, d_moy#36], functions=[sum(UnscaledValue(ss_sales_price#37))], output=[i_category#19, i_brand#20, s_store_name#21, s_company_name#22, d_year#35, d_moy#36, sum_sales#1])
         :                          +- Exchange hashpartitioning(i_category#19, i_brand#20, s_store_name#21, s_company_name#22, d_year#35, d_moy#36, 100), ENSURE_REQUIREMENTS, [plan_id=24]
         :                             +- HashAggregate(keys=[i_category#19, i_brand#20, s_store_name#21, s_company_name#22, d_year#35, d_moy#36], functions=[partial_sum(UnscaledValue(ss_sales_price#37))], output=[i_category#19, i_brand#20, s_store_name#21, s_company_name#22, d_year#35, d_moy#36, sum#39])
         :                                +- Project [i_brand#20, i_category#19, ss_sales_price#37, d_year#35, d_moy#36, s_store_name#21, s_company_name#22]
         :                                   +- SortMergeJoin [ss_store_sk#43], [s_store_sk#44], Inner
         :                                      :- Sort [ss_store_sk#43 ASC NULLS FIRST], false, 0
         :                                      :  +- Exchange hashpartitioning(ss_store_sk#43, 100), ENSURE_REQUIREMENTS, [plan_id=25]
         :                                      :     +- Project [i_brand#20, i_category#19, ss_store_sk#43, ss_sales_price#37, d_year#35, d_moy#36]
         :                                      :        +- SortMergeJoin [ss_sold_date_sk#45], [d_date_sk#46], Inner
         :                                      :           :- Sort [ss_sold_date_sk#45 ASC NULLS FIRST], false, 0
         :                                      :           :  +- Exchange hashpartitioning(ss_sold_date_sk#45, 100), ENSURE_REQUIREMENTS, [plan_id=26]
         :                                      :           :     +- Project [i_brand#20, i_category#19, ss_sold_date_sk#45, ss_store_sk#43, ss_sales_price#37]
         :                                      :           :        +- SortMergeJoin [i_item_sk#47], [ss_item_sk#48], Inner
         :                                      :           :           :- Sort [i_item_sk#47 ASC NULLS FIRST], false, 0
         :                                      :           :           :  +- Exchange hashpartitioning(i_item_sk#47, 100), ENSURE_REQUIREMENTS, [plan_id=27]
         :                                      :           :           :     +- Filter ((isnotnull(i_item_sk#47) AND isnotnull(i_category#19)) AND isnotnull(i_brand#20))
         :                                      :           :           :        +- FileScan parquet [i_item_sk#47,i_brand#20,i_category#19] Batched: true, DataFilters: [isnotnull(i_item_sk#47), isnotnull(i_category#19), isnotnull(i_brand#20)], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/<warehouse_dir>], PartitionFilters: [], PushedFilters: [IsNotNull(i_item_sk), IsNotNull(i_category), IsNotNull(i_brand)], ReadSchema: struct<i_item_sk:int,i_brand:string,i_category:string>
         :                                      :           :           +- Sort [ss_item_sk#48 ASC NULLS FIRST], false, 0
         :                                      :           :              +- Exchange hashpartitioning(ss_item_sk#48, 100), ENSURE_REQUIREMENTS, [plan_id=28]
         :                                      :           :                 +- Filter ((isnotnull(ss_item_sk#48) AND isnotnull(ss_sold_date_sk#45)) AND isnotnull(ss_store_sk#43))
         :                                      :           :                    +- FileScan parquet [ss_sold_date_sk#45,ss_item_sk#48,ss_store_sk#43,ss_sales_price#37] Batched: true, DataFilters: [isnotnull(ss_item_sk#48), isnotnull(ss_sold_date_sk#45), isnotnull(ss_store_sk#43)], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/<warehouse_dir>], PartitionFilters: [], PushedFilters: [IsNotNull(ss_item_sk), IsNotNull(ss_sold_date_sk), IsNotNull(ss_store_sk)], ReadSchema: struct<ss_sold_date_sk:int,ss_item_sk:int,ss_store_sk:int,ss_sales_price:decimal(7,2)>
         :                                      :           +- Sort [d_date_sk#46 ASC NULLS FIRST], false, 0
         :                                      :              +- Exchange hashpartitioning(d_date_sk#46, 100), ENSURE_REQUIREMENTS, [plan_id=29]
         :                                      :                 +- Filter ((((d_year#35 = 1999) OR ((d_year#35 = 1998) AND (d_moy#36 = 12))) OR ((d_year#35 = 2000) AND (d_moy#36 = 1))) AND isnotnull(d_date_sk#46))
         :                                      :                    +- FileScan parquet [d_date_sk#46,d_year#35,d_moy#36] Batched: true, DataFilters: [(((d_year#35 = 1999) OR ((d_year#35 = 1998) AND (d_moy#36 = 12))) OR ((d_year#35 = 2..., Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/<warehouse_dir>], PartitionFilters: [], PushedFilters: [Or(Or(EqualTo(d_year,1999),And(EqualTo(d_year,1998),EqualTo(d_moy,12))),And(EqualTo(d_year,2000)..., ReadSchema: struct<d_date_sk:int,d_year:int,d_moy:int>
         :                                      +- Sort [s_store_sk#44 ASC NULLS FIRST], false, 0
         :                                         +- Exchange hashpartitioning(s_store_sk#44, 100), ENSURE_REQUIREMENTS, [plan_id=30]
         :                                            +- Filter ((isnotnull(s_store_sk#44) AND isnotnull(s_store_name#21)) AND isnotnull(s_company_name#22))
         :                                               +- FileScan parquet [s_store_sk#44,s_store_name#21,s_company_name#22] Batched: true, DataFilters: [isnotnull(s_store_sk#44), isnotnull(s_store_name#21), isnotnull(s_company_name#22)], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/<warehouse_dir>], PartitionFilters: [], PushedFilters: [IsNotNull(s_store_sk), IsNotNull(s_store_name), IsNotNull(s_company_name)], ReadSchema: struct<s_store_sk:int,s_store_name:string,s_company_name:string>
         +- Sort [i_category#14 ASC NULLS FIRST, i_brand#15 ASC NULLS FIRST, s_store_name#16 ASC NULLS FIRST, s_company_name#17 ASC NULLS FIRST, (rn#18 - 1) ASC NULLS FIRST], false, 0
            +- Exchange hashpartitioning(i_category#14, i_brand#15, s_store_name#16, s_company_name#17, (rn#18 - 1), 100), ENSURE_REQUIREMENTS, [plan_id=31]
               +- Project [i_category#14, i_brand#15, s_store_name#16, s_company_name#17, sum_sales#1 AS sum_sales#11, rn#18]
                  +- Window [rank(d_year#40, d_moy#41) windowspecdefinition(i_category#14, i_brand#15, s_store_name#16, s_company_name#17, d_year#40 ASC NULLS FIRST, d_moy#41 ASC NULLS FIRST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#18], [i_category#14, i_brand#15, s_store_name#16, s_company_name#17], [d_year#40 ASC NULLS FIRST, d_moy#41 ASC NULLS FIRST]
                     +- Sort [i_category#14 ASC NULLS FIRST, i_brand#15 ASC NULLS FIRST, s_store_name#16 ASC NULLS FIRST, s_company_name#17 ASC NULLS FIRST, d_year#40 ASC NULLS FIRST, d_moy#41 ASC NULLS FIRST], false, 0
                        +- Exchange hashpartitioning(i_category#14, i_brand#15, s_store_name#16, s_company_name#17, 100), ENSURE_REQUIREMENTS, [plan_id=32]
                           +- HashAggregate(keys=[i_category#14, i_brand#15, s_store_name#16, s_company_name#17, d_year#40, d_moy#41], functions=[sum(UnscaledValue(ss_sales_price#49))], output=[i_category#14, i_brand#15, s_store_name#16, s_company_name#17, d_year#40, d_moy#41, sum_sales#1])
                              +- Exchange hashpartitioning(i_category#14, i_brand#15, s_store_name#16, s_company_name#17, d_year#40, d_moy#41, 100), ENSURE_REQUIREMENTS, [plan_id=33]
                                 +- HashAggregate(keys=[i_category#14, i_brand#15, s_store_name#16, s_company_name#17, d_year#40, d_moy#41], functions=[partial_sum(UnscaledValue(ss_sales_price#49))], output=[i_category#14, i_brand#15, s_store_name#16, s_company_name#17, d_year#40, d_moy#41, sum#50])
                                    +- Project [i_brand#15, i_category#14, ss_sales_price#49, d_year#40, d_moy#41, s_store_name#16, s_company_name#17]
                                       +- SortMergeJoin [ss_store_sk#51], [s_store_sk#52], Inner
                                          :- Sort [ss_store_sk#51 ASC NULLS FIRST], false, 0
                                          :  +- Exchange hashpartitioning(ss_store_sk#51, 100), ENSURE_REQUIREMENTS, [plan_id=34]
                                          :     +- Project [i_brand#15, i_category#14, ss_store_sk#51, ss_sales_price#49, d_year#40, d_moy#41]
                                          :        +- SortMergeJoin [ss_sold_date_sk#53], [d_date_sk#54], Inner
                                          :           :- Sort [ss_sold_date_sk#53 ASC NULLS FIRST], false, 0
                                          :           :  +- Exchange hashpartitioning(ss_sold_date_sk#53, 100), ENSURE_REQUIREMENTS, [plan_id=35]
                                          :           :     +- Project [i_brand#15, i_category#14, ss_sold_date_sk#53, ss_store_sk#51, ss_sales_price#49]
                                          :           :        +- SortMergeJoin [i_item_sk#55], [ss_item_sk#56], Inner
                                          :           :           :- Sort [i_item_sk#55 ASC NULLS FIRST], false, 0
                                          :           :           :  +- Exchange hashpartitioning(i_item_sk#55, 100), ENSURE_REQUIREMENTS, [plan_id=36]
                                          :           :           :     +- Filter ((isnotnull(i_item_sk#55) AND isnotnull(i_category#14)) AND isnotnull(i_brand#15))
                                          :           :           :        +- FileScan parquet [i_item_sk#55,i_brand#15,i_category#14] Batched: true, DataFilters: [isnotnull(i_item_sk#55), isnotnull(i_category#14), isnotnull(i_brand#15)], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/<warehouse_dir>], PartitionFilters: [], PushedFilters: [IsNotNull(i_item_sk), IsNotNull(i_category), IsNotNull(i_brand)], ReadSchema: struct<i_item_sk:int,i_brand:string,i_category:string>
                                          :           :           +- Sort [ss_item_sk#56 ASC NULLS FIRST], false, 0
                                          :           :              +- Exchange hashpartitioning(ss_item_sk#56, 100), ENSURE_REQUIREMENTS, [plan_id=37]
                                          :           :                 +- Filter ((isnotnull(ss_item_sk#56) AND isnotnull(ss_sold_date_sk#53)) AND isnotnull(ss_store_sk#51))
                                          :           :                    +- FileScan parquet [ss_sold_date_sk#53,ss_item_sk#56,ss_store_sk#51,ss_sales_price#49] Batched: true, DataFilters: [isnotnull(ss_item_sk#56), isnotnull(ss_sold_date_sk#53), isnotnull(ss_store_sk#51)], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/<warehouse_dir>], PartitionFilters: [], PushedFilters: [IsNotNull(ss_item_sk), IsNotNull(ss_sold_date_sk), IsNotNull(ss_store_sk)], ReadSchema: struct<ss_sold_date_sk:int,ss_item_sk:int,ss_store_sk:int,ss_sales_price:decimal(7,2)>
                                          :           +- Sort [d_date_sk#54 ASC NULLS FIRST], false, 0
                                          :              +- Exchange hashpartitioning(d_date_sk#54, 100), ENSURE_REQUIREMENTS, [plan_id=38]
                                          :                 +- Filter ((((d_year#40 = 1999) OR ((d_year#40 = 1998) AND (d_moy#41 = 12))) OR ((d_year#40 = 2000) AND (d_moy#41 = 1))) AND isnotnull(d_date_sk#54))
                                          :                    +- FileScan parquet [d_date_sk#54,d_year#40,d_moy#41] Batched: true, DataFilters: [(((d_year#40 = 1999) OR ((d_year#40 = 1998) AND (d_moy#41 = 12))) OR ((d_year#40 = 2..., Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/<warehouse_dir>], PartitionFilters: [], PushedFilters: [Or(Or(EqualTo(d_year,1999),And(EqualTo(d_year,1998),EqualTo(d_moy,12))),And(EqualTo(d_year,2000)..., ReadSchema: struct<d_date_sk:int,d_year:int,d_moy:int>
                                          +- Sort [s_store_sk#52 ASC NULLS FIRST], false, 0
                                             +- Exchange hashpartitioning(s_store_sk#52, 100), ENSURE_REQUIREMENTS, [plan_id=39]
                                                +- Filter ((isnotnull(s_store_sk#52) AND isnotnull(s_store_name#16)) AND isnotnull(s_company_name#17))
                                                   +- FileScan parquet [s_store_sk#52,s_store_name#16,s_company_name#17] Batched: true, DataFilters: [isnotnull(s_store_sk#52), isnotnull(s_store_name#16), isnotnull(s_company_name#17)], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/<warehouse_dir>], PartitionFilters: [], PushedFilters: [IsNotNull(s_store_sk), IsNotNull(s_store_name), IsNotNull(s_company_name)], ReadSchema: struct<s_store_sk:int,s_store_name:string,s_company_name:string>
